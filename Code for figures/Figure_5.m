%%

load('./results_all.mat')

%%

color = [hex2rgb( '00a8e1'); hex2rgb( '99cc00');...
    hex2rgb( 'ff6600'); hex2rgb( 'fcd300');...
    hex2rgb( '00994e'); hex2rgb( '008080');...
    hex2rgb( 'c8cc00'); hex2rgb( '808000');...
    hex2rgb( 'db00c2'); hex2rgb( '008080')];


datasize = [26, 26, 30, 25, 26, 26, 26, 26, 8, 26]*0.8;
Marker_all = {'o', 'v', 'square','diamond' ,'^',...
    'hexagram', '<', 'pentagram', '>', '*'} ;

vali_number = [3, 1, 1];
interval_number = [3, 3, 1];
legend1 = {'B1','B2','B7','B8','B11','B12'};
legend2 = {'B3','B4','B5','B6','B9','B10','B13','B14','B15','B17'};
legend3 = {'B16','B18','B19','B20','B21'};
legend_all = {};
legend_all{1} = legend1;
legend_all{2} = legend2;
legend_all{3} = legend3;
ylim_all = [1000, 2500, 115];


title_all = {'Cluster 1', 'Cluster 2', 'Cluster 3'};
clusters_name = {'cluster1', 'cluster2', 'cluster3'}


figureUnits = 'centimeters';

figureWidth = 35*0.8;
figureHeight = 36*0.81;

figure1 = figure;
set(gcf, 'Units', figureUnits, 'Position', [0 28 figureWidth figureHeight], ...
        'Color', [1, 1, 1]);

annotation(figure1,'line',[0.0151171579743008 0.984882842025699],...
    [0.995 0.995]);

annotation(figure1,'textbox',...
    [0.38 0.99 0.26 0.0154298310066128],...
    'String',{'Prediction results after calibration'}, ...
    'FontName','Arial', ...
    'FontSize',11.5,...
    'FitBoxToText','off',...
    'EdgeColor','none',...
    'BackgroundColor',[1 1 1], ...
    'HorizontalAlignment', 'center');

annotation(figure1,'line',[0.0151171579743007 0.984882842025699],...
    [0.66 0.66 ]);

annotation(figure1,'textbox',...
    [0.390030234315949 0.656 0.26 0.0154298310066128],...
    'String','Prediction results before calibration', ...
    'FontName','Arial', ...
    'FontSize',11.5,...
    'FitBoxToText','off',...
    'EdgeColor','none',...
    'BackgroundColor',[1 1 1], ...
    'HorizontalAlignment', 'center');

annotation(figure1,'line',[0.0173847316704459 0.987150415721844],...
    [0.325 0.325 ]);

annotation(figure1,'textbox',...
    [0.370030234315949 0.322 0.3 0.0154298310066127],...
    'String','Prediction results without simulation features',...
    'FontName','Arial', ...
    'FontSize',11.5,...
    'FitBoxToText','off',...
    'EdgeColor','none',...
    'BackgroundColor',[1 1 1], ...
    'HorizontalAlignment', 'center');


type='compact';
for methods_name = 1:3
    if methods_name == 1
        results_all = result_cali;
    elseif methods_name == 2
        results_all = result_nocali;
    else
        results_all = result_VIT;
    end
    
    
    for cluster_number = 1:3
        max_len = 0;
        %         axes1 = subplot(3, 3, cluster_number+(methods_name-1)*3)
        axes1 = tsubplot(3, 3, cluster_number+(methods_name-1)*3,type);
        axis square;
        hold on
        
        for battery_number = 1:length(legend_all{cluster_number})
            pred = results_all.(legend_all{cluster_number}{battery_number})(vali_number(cluster_number)).pred;
            label = results_all.(legend_all{cluster_number}{battery_number})(vali_number(cluster_number)).label;
            cycle_number = length(label):-1:1;
            if cluster_number == 3
                MarkerEdgealpha = 0.6;
                MarkerFaceAlpha = 0.1;
            else
                MarkerEdgealpha = 0.6;
                MarkerFaceAlpha = 0.1;
            end
            scatter(cycle_number(1:interval_number(cluster_number):end),...
                pred(1:interval_number(cluster_number):end),...
                'MarkerEdgealpha', MarkerEdgealpha, ...
                'MarkerEdgeColor',color(battery_number,:), ...
                'MarkerFaceAlpha', MarkerFaceAlpha, ...
                'MarkerFaceColor',color(battery_number,:), ...
                'Marker',Marker_all{battery_number},...
                'SizeData', datasize(battery_number))
            if max_len < length(label)
                max_len = length(label);
            end
        end
        
        cycle_number = max_len:-100:1;
        plot(cycle_number, cycle_number, '-.','linewidth',2.5, ...
            'color', hex2rgb( 'fa4343'))
        %
        xlim([-max_len*0.01, max_len*1.01]);
        ylim([-max_len*0.01, max_len*1.01])
        set(gca,'XDir','reverse', 'TickDir', 'out')
        
        legend(legend_all{cluster_number},'NumColumns',1, 'box', 'off', ...
            'FontName','Arial','FontSize',8.5)
        %     set(legend1,'NumColumns',2);
        xlabel('True RUL')
        ylabel('Predicted RUL')
        set(gca,'FontName','Arial','FontSize',8.5);
        %     set(gca,'FontName','Times New Roman','FontSize',11);
        title(title_all{cluster_number},'FontName','Arial','FontSize',11);
        if cluster_number == 3
            set(gca, 'YTick', [0:20:180], ...
                'YTickLabel',{'  0', '    20','40','60', '80', '100', '120', '140', '160', '   180'})
        end
        
        

        position2 = [axes1.Position(1)+ 0.033, axes1.Position(2)+0.042, ...
            0.115 0.078]
        axes2 = axes('Units','normalized','Position', position2, 'box', 'off', ...
            'Color', 'none');
  
        clus_pred =results_all.(clusters_name{cluster_number})(vali_number(cluster_number)).pred;
        clus_label =results_all.(clusters_name{cluster_number})(vali_number(cluster_number)).label;
        h = histogram(clus_pred-clus_label, 15,'LineWidth',1);
        h.FaceColor = hex2rgb( 'e9e7e8 ');
        h.EdgeColor = hex2rgb( '000000 ');
        ylim([0, ylim_all(cluster_number)]);
        %     xlabel('AE')
        set(axes2,'Color','none','FontName','Arial','FontSize', 8, 'TickDir', 'out');
        box off

    end

end


bottom_  = 0.912;
bottom_2  = 0.582;
bottom_3 = 0.248;

bottom_  = 0.892161645848638;
bottom_2  = 0.561426891991181;
bottom_3 = 0.227426891991183;


left_ = 0.01;
gap_hor = 0.3333333;
font_size = 12.5;
annotation(figure1,'textbox',...
    [left_ bottom_ 0.03, 0.094],...
    'String',{'a'},...
    'FontWeight','bold',...
    'FontSize',font_size,...
    'FontName','Arial',...
    'EdgeColor','none');


annotation(figure1,'textbox',...
    [left_ + gap_hor, bottom_ 0.03 0.094],...
    'String',{'b'},...
    'FontWeight','bold',...
    'FontSize',font_size,...
    'FontName','Arial',...
    'EdgeColor','none');


annotation(figure1,'textbox',...
    [left_ + gap_hor*2, bottom_ 0.03 0.094],...
    'String',{'c'},...
    'FontWeight','bold',...
    'FontSize',font_size,...
    'FontName','Arial',...
    'EdgeColor','none');

annotation(figure1,'textbox',...
    [left_ bottom_2 0.03, 0.094],...
    'String',{'d'},...
    'FontWeight','bold',...
    'FontSize',font_size,...
    'FontName','Arial',...
    'EdgeColor','none');


annotation(figure1,'textbox',...
    [left_ + gap_hor, bottom_2 0.03 0.094],...
    'String',{'e'},...
    'FontWeight','bold',...
    'FontSize',font_size,...
    'FontName','Arial',...
    'EdgeColor','none');


annotation(figure1,'textbox',...
    [left_ + gap_hor*2, bottom_2 0.03 0.094],...
    'String',{'f'},...
    'FontWeight','bold',...
    'FontSize',font_size,...
    'FontName','Arial',...
    'EdgeColor','none');

annotation(figure1,'textbox',...
    [left_ bottom_3 0.03, 0.094],...
    'String',{'g'},...
    'FontWeight','bold',...
    'FontSize',font_size,...
    'FontName','Arial',...
    'EdgeColor','none');


annotation(figure1,'textbox',...
    [left_ + gap_hor, bottom_3 0.03 0.094],...
    'String',{'h'},...
    'FontWeight','bold',...
    'FontSize',font_size,...
    'FontName','Arial',...
    'EdgeColor','none');


annotation(figure1,'textbox',...
    [left_ + gap_hor*2, bottom_3 0.03 0.094],...
    'String',{'i'},...
    'FontWeight','bold',...
    'FontSize',font_size,...
    'FontName','Arial',...
    'EdgeColor','none');


AE_left = 0.097;
AE_bottom1 = 0.73;
AE_bottom2 = 0.396;
AE_bottom3 = 0.063;
gap_hor = 0.335;
font_size_AE = 10.5;

% position的格式为[left, bottom, width, height]
annotation(figure1,'textbox',...
    [AE_left, AE_bottom1 0.0299861111111111 0.0808038485412787],...
    'String',{'AE'},...
    'FontSize',font_size_AE,...
    'FontName','Arial',...
    'EdgeColor','none');


annotation(figure1,'textbox',...
    [AE_left + gap_hor,  AE_bottom1 0.0299861111111111 0.0808038485412787],...
    'String',{'AE'},...
    'FontSize',font_size_AE,...
    'FontName','Arial',...
    'EdgeColor','none');


annotation(figure1,'textbox',...
    [AE_left + gap_hor *2, AE_bottom1 0.0299861111111112 0.0808038485412787],...
    'String',{'AE'},...
    'FontSize',font_size_AE,...
    'FontName','Arial',...
    'EdgeColor','none');

annotation(figure1,'textbox',...
    [AE_left, AE_bottom2 0.0299861111111111 0.0808038485412787],...
    'String',{'AE'},...
    'FontSize',font_size_AE,...
    'FontName','Arial',...
    'EdgeColor','none');

annotation(figure1,'textbox',...
    [AE_left + gap_hor,  AE_bottom2 0.0299861111111111 0.0808038485412787],...
    'String',{'AE'},...
    'FontSize',font_size_AE,...
    'FontName','Arial',...
    'EdgeColor','none');

annotation(figure1,'textbox',...
    [AE_left + gap_hor *2, AE_bottom2 0.0299861111111112 0.0808038485412787],...
    'String',{'AE'},...
    'FontSize',font_size_AE,...
    'FontName','Arial',...
    'EdgeColor','none');

annotation(figure1,'textbox',...
    [AE_left, AE_bottom3 0.0299861111111111 0.0808038485412787],...
    'String',{'AE'},...
    'FontSize',font_size_AE,...
    'FontName','Arial',...
    'EdgeColor','none');


annotation(figure1,'textbox',...
    [AE_left + gap_hor,  AE_bottom3 0.0299861111111111 0.0808038485412787],...
    'String',{'AE'},...
    'FontSize',font_size_AE,...
    'FontName','Arial',...
    'EdgeColor','none');


annotation(figure1,'textbox',...
    [AE_left + gap_hor *2, AE_bottom3 0.0299861111111112 0.0808038485412787],...
    'String',{'AE'},...
    'FontSize',font_size_AE,...
    'FontName','Arial',...
    'EdgeColor','none');



%%
function rgb = hex2rgb(hexColor)
r = hex2dec(hexColor(1:2));
g = hex2dec(hexColor(3:4));
b = hex2dec(hexColor(5:6));
rgb = [r, g, b]./255;
end

function ax=tsubplot(rows,cols,ind,type)
 
if nargin<4,type='tight';end
sz=[rows,cols];
ratio1=[0,0,1,1];
switch type
    case 'tight'
        ratio1=[0,0,1,1];
        % ratio2=[0.031 0.054 0.9619 0.9254];
    case 'compact'
        ratio1=[0.034 0.0127 0.9256 0.9704];
        % ratio2=[0.065 0.0667 0.8875 0.8958];
    case 'loose'
        ratio1=[0.099 0.056 0.8131 0.8896];
        % ratio2=[0.13 0.11 0.775 0.815];
end
k=1;
posList=zeros(sz(1)*sz(2),4);
for i=1:sz(1)
    for j=1:sz(2)
        tpos=[(j-1)/sz(2),(sz(1)-i)/sz(1),1/sz(2),1/sz(1)];
        posList(k,:)=[tpos(1)+tpos(3).*ratio1(1),tpos(2)+tpos(4).*ratio1(2),...
                      tpos(3).*ratio1(3),tpos(4).*ratio1(4)];
        k=k+1;
    end
end
posSet=posList(ind(:),:);
xmin=min(posSet(:,1));
ymin=min(posSet(:,2));
xmax=max(posSet(:,1)+posSet(:,3));
ymax=max(posSet(:,2)+posSet(:,4));
ax=axes('Parent',gcf,'LooseInset',[0,0,0,0],...
    'OuterPosition',[xmin,ymin,xmax-xmin,ymax-ymin]);
 
end

